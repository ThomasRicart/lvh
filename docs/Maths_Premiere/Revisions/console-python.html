<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labo Python Pro - Sp√© Maths</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #output { background-color: #1e1e1e; color: #d4d4d4; font-family: monospace; min-height: 80px; }
        .py-error { color: #ff5555; }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        <div class="bg-emerald-800 p-4 text-white font-bold text-xl">üíª Console Python Interactive</div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">√âditeur (Tab et Auto-indentation actifs)</label>
                <textarea id="code-editor" class="w-full h-96 p-4 bg-slate-900 text-emerald-400 font-mono rounded-lg outline-none border-2 border-slate-700 focus:border-emerald-500" spellcheck="false">
### Tapez votre code ici puis cliquez sur Ex√©cuter
</textarea>
                <button id="run-button" py-click="run_python" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-lg">‚ñ∂ Ex√©cuter le code</button>
            </div>

            <div class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Sortie Console</label>
                    <div id="output" class="p-4 rounded-lg overflow-y-auto whitespace-pre-wrap text-sm"></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Graphique Matplotlib</label>
                    <div id="graph-area" class="bg-white border-2 border-dashed border-slate-200 rounded-lg min-h-[250px] flex items-center justify-center"></div>
                </div>
            </div>
        </div>
    </div>

    <py-config>
        packages = ["matplotlib"]
    </py-config>

    <script>
        const editor = document.getElementById('code-editor');

        editor.addEventListener('keydown', function(e) {
            // Gestion de la touche TAB
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
            }

            // Gestion de la touche ENTR√âE
            if (e.key === 'Enter') {
                const start = this.selectionStart;
                const value = this.value;
                
                // On cherche le d√©but de la ligne actuelle
                const lastNewline = value.lastIndexOf('\n', start - 1);
                const lineText = value.substring(lastNewline + 1, start);
                
                // On r√©cup√®re l'indentation actuelle (espaces au d√©but)
                const indentMatch = lineText.match(/^\s*/);
                const currentIndent = indentMatch ? indentMatch[0] : "";
                
                // On v√©rifie si la ligne finit par ":"
                const addsIndent = lineText.trim().endsWith(':');
                const extraIndent = addsIndent ? "    " : "";

                e.preventDefault(); // On bloque le "Entr√©e" normal
                
                const insertion = "\n" + currentIndent + extraIndent;
                this.value = value.substring(0, start) + insertion + value.substring(start);
                
                // On place le curseur apr√®s l'insertion
                this.selectionStart = this.selectionEnd = start + insertion.length;
            }
        });
    </script>

    <script type="py">
        from pyscript import display, document
        import matplotlib.pyplot as plt

        def run_python(event):
            code = document.getElementById("code-editor").value
            output_div = document.getElementById("output")
            graph_area = document.getElementById("graph-area")
            output_div.innerHTML = ""
            graph_area.innerHTML = ""
            
            try:
                def custom_print(*args, **kwargs):
                    text = " ".join(map(str, args))
                    output_div.innerHTML += text + "\n"
                
                # Ex√©cution avec redirection du display vers graph-area
                exec(code, {"print": custom_print, "plt": plt, "display": lambda x: display(x, target="graph-area")})
            except Exception as e:
                output_div.innerHTML = f'<span class="py-error">Erreur : {str(e)}</span>'
    </script>
</body>
</html>